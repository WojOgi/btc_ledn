<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bitcoin Buy-Borrow-Die Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 p-4 md:p-6">
  <h1 class="text-xl md:text-2xl font-bold mb-3">Bitcoin Buy-Borrow-Die Simulator</h1>

  <p class="text-xs md:text-sm mb-3 text-gray-600 max-w-3xl">
    Each year you draw a loan against your Bitcoin—starting at <strong>First Loan Amount</strong> and growing by
    <em>Loan Growth %</em>. Nothing is repaid; all previous loans keep accruing interest. The tool shows overall LTV, per-loan stats,
    and the <strong>monthly pension</strong> each new loan could provide (principal ÷ 12).
  </p>

  <!-- ▸ Inputs ------------------------------------------------------------ -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-4 text-sm">
    <label class="flex flex-col gap-1">Initial BTC Collateral (₿)
      <input id="btcCollateral" type="number" step="0.0001" class="p-1 border rounded" value="0.5" />
    </label>
    <label class="flex flex-col gap-1">First Loan Amount (PLN)
      <input id="loanAmount" type="number" class="p-1 border rounded" value="50000" />
    </label>
    <label class="flex flex-col gap-1">Loan Growth / Year (%)
      <input id="loanGrowth" type="number" step="0.1" class="p-1 border rounded" value="5" />
    </label>
    <label class="flex flex-col gap-1">Initial BTC CAGR (%)
      <input id="btcCagr" type="number" step="0.1" class="p-1 border rounded" value="45" />
    </label>
    <label class="flex flex-col gap-1">BTC CAGR Drop Factor (%)
      <input id="btcCagrDrop" type="number" step="0.1" class="p-1 border rounded" value="5" />
    </label>
    <label class="flex flex-col gap-1">Years Until Strategy Starts
      <input id="delayYears" type="number" class="p-1 border rounded" value="0" />
    </label>
    <label class="flex flex-col gap-1">Strategy Duration (Years)
      <input id="runYears" type="number" class="p-1 border rounded" value="10" />
    </label>
    <label class="flex flex-col gap-1">Interest Rate (%)
      <input id="interestRate" type="number" step="0.01" class="p-1 border rounded" value="12.5" />
    </label>
    <label class="flex flex-col gap-1">Origination Fee (%)
      <input id="origFee" type="number" step="0.1" class="p-1 border rounded" value="2" />
    </label>
    <label class="flex flex-col gap-1">Chart Height (px)
      <input id="chartHeight" type="number" class="p-1 border rounded" value="200" />
    </label>
  </div>

  <!-- ▸ Action ------------------------------------------------------------ -->
  <button id="runBtn" class="bg-blue-600 text-white text-sm px-3 py-1.5 rounded shadow">Run Simulation</button>
  <span id="status" class="ml-3 text-sm"></span>

  <!-- ▸ Table ------------------------------------------------------------- -->
  <div class="overflow-x-auto mt-5 max-h-[60vh]">
    <table id="resultsTable" class="min-w-full border text-xs"></table>
  </div>

  <!-- ▸ Chart ------------------------------------------------------------- -->
  <div class="mt-6 max-w-5xl">
    <canvas id="chart"></canvas>
  </div>

<script>
/***** helpers *****/
const val = id => +document.getElementById(id).value;
const fmt = n => n.toLocaleString('pl-PL', { maximumFractionDigits: 2 });
let chart;

async function getBTCPricePLN(){
  const res = await fetch('https://api.coinbase.com/v2/prices/BTC-PLN/spot');
  const json = await res.json();
  return +json.data.amount;
}

/***** main *****/
document.getElementById('runBtn').addEventListener('click', runSimulation);

async function runSimulation(){
  const status=document.getElementById('status');
  status.textContent='Fetching BTC price…';
  let spot;
  try{ spot=await getBTCPricePLN(); }catch{ status.textContent='Price fetch failed'; return; }

  /* inputs */
  const collateralBTC  = val('btcCollateral');
  const firstLoanPLN   = val('loanAmount');
  const loanGrowthRate = val('loanGrowth')/100;
  const initCagr       = val('btcCagr')/100;
  const dropPct        = val('btcCagrDrop')/100;
  const delay          = val('delayYears');
  const years          = val('runYears');
  const intRate        = val('interestRate')/100;
  const feeRate        = val('origFee')/100;
  const chartH         = val('chartHeight');

  /* simulation state */
  let btcPrice=spot;
  const annualGrowth=y=> initCagr*Math.pow(1-dropPct,y);

  const loans=[]; // each: {balance, initialLtv, pension}
  const totalDebt=()=>loans.reduce((s,l)=>s+l.balance,0);
  const rows=[];
  let nextLoan=firstLoanPLN;

  for(let y=0;y<=years;y++){
    if(y>0) btcPrice*=1+annualGrowth(y-1);
    loans.forEach(l=> l.balance*=1+intRate);

    const collVal=collateralBTC*btcPrice;
    let newLoan=0, fee=0, initLtv=0, pension=0;
    if(y>=delay){
      newLoan=nextLoan;
      fee=newLoan*feeRate;
      initLtv=newLoan/collVal;
      pension=newLoan/12;
      loans.push({balance:newLoan+fee, initialLtv:initLtv, pension:pension});
      nextLoan*=1+loanGrowthRate;
    }

    rows.push({
      year:y,
      btcPrice,
      collVal,
      growth:annualGrowth(y),
      newLoan,
      pension,
      fee,
      debt:totalDebt(),
      ltv:totalDebt()/collVal,
      loans:loans.map((l,i)=>({idx:i+1,...l}))
    });
  }

  renderTable(rows);
  renderChart(rows,chartH);
  status.textContent=`Simulation complete — spot ${fmt(spot)} PLN`;
}

/***** table *****/
function renderTable(rows){
  const tbl=document.getElementById('resultsTable');
  tbl.innerHTML='';

  const headers=['Year','BTC Price','Collateral PLN','Growth %','New Loan','Pension /mo','Fee','Total Debt','Overall LTV %','Loans (balance / init LTV / pension)'];
  const thead=document.createElement('thead');
  const trh=document.createElement('tr');
  headers.forEach(h=>{
    const th=document.createElement('th');
    th.textContent=h; th.className='border px-1 py-0.5 bg-gray-100';
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody=document.createElement('tbody');
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const data=[
      r.year,
      fmt(r.btcPrice),
      fmt(r.collVal),
      (r.growth*100).toFixed(2)+'%',
      fmt(r.newLoan),
      fmt(r.pension),
      fmt(r.fee),
      fmt(r.debt),
      (r.ltv*100).toFixed(2)+'%',
      r.loans.map(l=>`L${l.idx}: ${fmt(l.balance)} (init ${(l.initialLtv*100).toFixed(1)}%) – ${fmt(l.pension)}/mo`).join('<br>')
    ];

    data.forEach((v,i)=>{
      const td=document.createElement('td');
      if(i===9){ td.innerHTML=v; td.className='border px-1 py-0.5 text-left'; }
      else{ td.textContent=v; td.className='border px-1 py-0.5'+(i? ' text-right':''); }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}

/***** chart *****/
function renderChart(rows,height){
  const canvas=document.getElementById('chart');
  canvas.height=height||200;
  const ctx=canvas.getContext('2d');
  const labels=rows.map(r=>r.year);
  const debt=rows.map(r=>r.debt);
  const coll=rows.map(r=>r.collVal);
  const ltv=rows.map(r=>r.ltv*100);
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[
      {label:'Total Debt (PLN)',data:debt,borderWidth:1,yAxisID:'y'},
      {label:'Collateral Value (PLN)',data:coll,borderWidth:1,yAxisID:'y'},
      {label:'Overall LTV %',data:ltv,borderWidth:1,yAxisID:'y1'}]},
    options:{responsive:true,interaction:{mode:'index',intersect:false},
      scales:{y:{type:'linear',position:'left',title:{display:true,text:'PLN'}},
              y1:{type:'linear',position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'LTV %'}}},
      plugins:{legend:{display:true}}}
  });
}
</script>
</body>
</html>
